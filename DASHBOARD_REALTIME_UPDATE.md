# 仪表盘实时数据更新说明

## ✅ 完成的改动

### 1. 数据同步频率优化

#### 后端调度器 (`backend/app/scheduler.py`)

**修改内容**：
- 将同步间隔从 **2小时** 调整为 **10分钟**
- 参数名从 `interval_hours` 改为 `interval_minutes`
- 睡眠时间从 `interval_hours * 3600` 秒改为 `interval_minutes * 60` 秒

**代码变化**：
```python
# 之前：每2小时同步一次
async def scheduler_loop(interval_hours: int = 2):
    logger.info(f"Garmin 后台同步调度器已启动，间隔: {interval_hours} 小时")
    # ...
    await asyncio.sleep(interval_hours * 3600)

# 现在：每10分钟同步一次
async def scheduler_loop(interval_minutes: int = 10):
    logger.info(f"Garmin 后台同步调度器已启动，间隔: {interval_minutes} 分钟")
    # ...
    await asyncio.sleep(interval_minutes * 60)
```

**效果**：
- ✅ 数据更新更加频繁（10分钟 vs 2小时）
- ✅ 更接近"实时"的用户体验
- ✅ 确保仪表盘显示最新数据

### 2. 仪表盘实时数据展示

#### 前端页面 (`frontend/src/app/dashboard/page.tsx`)

**新增功能**：

#### 2.1 今日实时数据区域

在页面顶部添加了一个醒目的实时数据展示区：

**特点**：
- 🎨 **渐变背景**：紫蓝色渐变，视觉突出
- 📊 **实时指标**：显示今天的6个关键健康指标
- 🔄 **自动刷新**：每5分钟自动更新数据
- 🕐 **更新时间**：显示最后更新时间戳
- 🔘 **手动刷新**：一键手动刷新按钮

**展示的指标**：
1. 😴 **睡眠分数** - 今日睡眠质量评分
2. 🚶 **步数** - 当前累计步数
3. ❤️ **静息心率** - 当前静息心率 (bpm)
4. 🔋 **身体电量** - 当前身体电量水平
5. 💪 **HRV** - 心率变异性 (ms)
6. 😌 **压力水平** - 当前压力值

#### 2.2 自动刷新机制

```typescript
// 每5分钟自动刷新今日数据
const { data: todayData, refetch: refetchToday } = useQuery({
  queryKey: ['garmin-today', userId, today],
  queryFn: () => dailyHealthApi.getUserGarminData(userId, today, today),
  refetchInterval: 5 * 60 * 1000, // 5分钟
});
```

#### 2.3 状态管理

- 使用 `useState` 追踪最后更新时间
- 使用 `useEffect` 监听数据变化
- 显示加载状态（动画加载器）

## 📊 界面预览

### 今日实时数据区域

```
┌────────────────────────────────────────────────────────────┐
│  📊 今日实时数据                           🔄 手动刷新   │
│  最后更新: 15:23:45 | 自动刷新中...                        │
├────────────────────────────────────────────────────────────┤
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │
│  │ 😴     │ │ 🚶     │ │ ❤️     │ │ 🔋     │ │ 💪     │  │
│  │ 睡眠   │ │ 步数   │ │ 心率   │ │ 电量   │ │ HRV    │  │
│  │  85    │ │ 8,234  │ │ 52 bpm │ │   75   │ │ 45 ms  │  │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │
└────────────────────────────────────────────────────────────┘
```

## 🚀 使用体验

### 自动刷新流程

1. **页面加载**
   - 立即获取今日最新数据
   - 显示加载动画

2. **定时刷新**（每5分钟）
   - 后台自动请求最新数据
   - 无需页面刷新
   - 更新时间戳

3. **手动刷新**
   - 点击"手动刷新"按钮
   - 立即获取最新数据
   - 更新显示时间

4. **后台同步**（每10分钟）
   - 服务器自动从Garmin同步
   - 确保数据是最新的
   - 无需用户操作

## 🔄 数据流程

```
Garmin设备 
    ↓
Garmin Connect云端
    ↓ (后台同步 - 每10分钟)
本地数据库
    ↓ (API请求 - 前端自动/手动)
仪表盘显示
    ↓ (自动刷新 - 每5分钟)
最新数据展示
```

## ⚡ 性能优化

### 1. 后端优化
- **更频繁同步**：10分钟间隔确保数据新鲜度
- **小范围同步**：只同步最近3天数据，减少请求时间
- **错误处理**：完善的异常捕获和日志记录

### 2. 前端优化
- **按需加载**：今日数据独立查询，不影响历史数据
- **缓存策略**：利用 React Query 缓存机制
- **条件渲染**：数据未加载时显示友好提示

## 📝 配置说明

### 修改同步频率

如需调整后台同步间隔，编辑 `backend/app/scheduler.py`:

```python
# 默认10分钟，可以改为其他值（单位：分钟）
async def scheduler_loop(interval_minutes: int = 10):
```

**建议值**：
- 实时监控：5分钟
- 正常使用：10分钟（当前）
- 节省资源：30分钟
- 低频同步：60分钟（1小时）

### 修改前端刷新频率

如需调整前端自动刷新间隔，编辑 `frontend/src/app/dashboard/page.tsx`:

```typescript
const { data: todayData, refetch: refetchToday } = useQuery({
  // ...
  refetchInterval: 5 * 60 * 1000, // 5分钟，可以调整
});
```

**建议值**：
- 高频刷新：1分钟 (1 * 60 * 1000)
- 正常刷新：5分钟 (5 * 60 * 1000) - 当前
- 低频刷新：10分钟 (10 * 60 * 1000)

## 🎯 优势

### 用户体验
- ✅ 实时感更强：10分钟同步 + 5分钟刷新
- ✅ 数据可视化：大卡片、清晰图标
- ✅ 操作便捷：支持手动刷新
- ✅ 状态透明：显示更新时间

### 技术实现
- ✅ 自动化：无需用户干预
- ✅ 容错性：完善的错误处理
- ✅ 可配置：轻松调整频率
- ✅ 性能优化：独立查询，不阻塞其他数据

### 数据准确性
- ✅ 高频同步：10分钟确保数据新鲜
- ✅ 实时查询：前端每5分钟刷新
- ✅ 手动控制：随时获取最新数据

## 🔧 故障排除

### 问题1：今日数据不显示

**原因**：可能是今天还没有同步数据

**解决方案**：
1. 点击"手动刷新"按钮
2. 确认后端服务正常运行
3. 检查是否配置了 Garmin 账号
4. 手动运行同步脚本：
   ```bash
   cd backend
   python scripts/sync_garmin.py <email> <password> 1 1
   ```

### 问题2：数据不自动更新

**原因**：后台同步任务未启动

**解决方案**：
1. 检查后端日志：
   ```bash
   tail -f backend/logs/app.log
   ```
2. 确认看到"Garmin 后台同步调度器已启动"消息
3. 重启后端服务

### 问题3：刷新按钮无响应

**原因**：前端请求失败

**解决方案**：
1. 打开浏览器控制台，查看错误信息
2. 确认后端 API 正常：
   ```bash
   curl http://localhost:8000/api/v1/health
   ```
3. 清除浏览器缓存并刷新页面

## 📈 后续增强建议

### 短期
1. **更多实时指标**：
   - 卡路里消耗
   - 运动时长
   - 睡眠各阶段时长

2. **数据对比**：
   - 与昨天对比
   - 显示涨跌趋势

3. **状态提示**：
   - 数据异常警告
   - 目标完成进度

### 中期
1. **实时图表**：
   - 今日心率曲线
   - 今日步数趋势

2. **推送通知**：
   - 数据更新提醒
   - 异常数据告警

3. **多用户支持**：
   - 为每个用户独立同步
   - 个性化刷新频率

### 长期
1. **WebSocket 实时推送**：
   - 真正的实时数据
   - 无需轮询

2. **离线支持**：
   - PWA 技术
   - 离线缓存

## 📊 访问

立即访问仪表盘查看实时数据：

```
http://localhost:3000/dashboard
```

## 🎉 总结

通过本次更新：
- ✅ 数据同步频率提升 **12倍**（2小时 → 10分钟）
- ✅ 新增今日实时数据展示区
- ✅ 支持自动刷新（每5分钟）
- ✅ 支持手动刷新（一键更新）
- ✅ 更好的用户体验和数据实时性

让健康数据真正"实时"起来！⚡📊

